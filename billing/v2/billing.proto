syntax = "proto3";

package blueapi.billing.v2;

import "api/account.proto";
import "api/costtag.proto";
import "api/ripple/billinggroup.proto";
import "google/api/annotations.proto";
import "google/protobuf/field_mask.proto";
import "protoc-gen-openapiv2/options/annotations.proto";

option go_package = "github.com/alphauslabs/blueapi/billing/v2";
option java_package = "cloud.alphaus.api.billing.v2";
option java_outer_classname = "V2BillingProto";

// Billing service definition V2.
service Billing {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_tag) = {
    description: "(BETA) Billing API V2. Base URL: https://api.alphaus.cloud/m/blue/billing/v2"
    external_docs: {
      url: "https://github.com/alphauslabs/blueapi/tree/main/billing/v2";
      description: "Service definition";
    }
  };

  // Lists all billing groups with pagination support.
  rpc ListBillingGroups(ListBillingGroupsRequest) returns (ListBillingGroupsResponse) {
    option (google.api.http) = {
      get: "/v2/billinggroups"
    };
  }
}

// BillingGroup message - reusing the same structure for compatibility
message BillingGroup {
  // The billing group's internal id.
  string billingInternalId = 1;

  // The billing group id.
  string billingGroupId = 2;

  // The billing group name.
  string billingGroupName = 3;

  // The company's name.
  string companyName = 7;

  // For aws only: `default` or `imported`
  string type = 12;

  // The billing group info
  api.ripple.BillingGroupInfo billingGroupInfo = 10;

  // The account options.
  AccountOptions accountOptions = 8;

  // List of all accounts
  repeated api.Account accounts = 4;

  // List of all tags
  repeated api.CostTag tags = 6;

  // The invoice settings for this billing group.
  BillingGroupInvoiceSettings invoiceSettings = 5;

  // List of all additionalItems
  BillingGroupAdditionalItems additionalItems = 11;

  // AWS-specific options
  AwsOptions awsOptions = 9;
}

// Additional items for a billing group.
message BillingGroupAdditionalItems {
  // Note: AdditionalItems type not imported in V2 for simplicity
  // Define specific fields as needed
}

// Invoice settings for a billing group.
message BillingGroupInvoiceSettings {
  // AWS invoice settings
  BillingGroupVendoredInvoiceSetting aws = 1;

  // Azure invoice settings
  BillingGroupVendoredInvoiceSetting azure = 2;

  // GCP invoice settings
  BillingGroupVendoredInvoiceSetting gcp = 3;
}

// Invoice settings that are vendor-specific for each billing group.
message BillingGroupVendoredInvoiceSetting {
  string calcType = 1;
  double discountRate = 2;
  string substitutionFee = 3;
  double substitutionFix = 4;
  double substitutionRate = 5;
  string supportFee = 6;
  double supportRate = 7;
  double supportFix = 8;
  double taxRate = 9;
  string currency = 10;
  string discountTargetUsage = 11;
  string substitutionFeeTargetUsage = 12;
  string discountCalcLogic = 13;
  string substitutionFeeCalcTarget = 14;
  string substitutionFeeCalcType = 15;
  string supportAmountTarget = 16;
  string supportFeeCalcTarget = 17;
}

message AwsOptions {
  bool useProFormaCur = 1;

  // Must not be empty if useProFormaCur is true.
  string payerId = 2;
}

// Account options definition.
message AccountOptions {
  // AWS register accounts
  RegisterAccounts aws = 1;
  // GCP register accounts
  RegisterAccounts gcp = 2;
  // Azure register accounts
  RegisterAccounts azure = 3;
}

// Register Accounts definition
message RegisterAccounts {
  // Optional.
  // If enabled, any additional accounts will be automatically enrolled into the billing group.
  // If disabled, register the account manually.
  // 
  // For GCP, Register projectId under the specific Sub billing account.
  // For AWS, Register accountId under the specific payer account into the billing group
  bool enabled = 1;

  // Optional. AccountId to be used for registration into the billing group.
  string accountId = 2;
}

// Request message for the Billing.ListBillingGroups rpc.
message ListBillingGroupsRequest {
  // Optional. Get only the value that set fieldMask.
  //
  // see more info: https://github.com/protocolbuffers/protobuf/blob/main/src/google/protobuf/field_mask.proto
  google.protobuf.FieldMask field_mask = 1;

  // Optional. Filter vendor accounts included in BillingGroup. Format: vendors=vendor1,vendor2,vendor3.
  // For example, When Aws and Gcp to be filtered vendors=aws,gcp
  // If you want to get all vendors, not set parameter.
  string vendors = 2;

  // Optional. Filter by calcType. Format: calType=account
  // Valid values: account, tag
  string calcType = 3;

  // Optional. Filter by displayCost. Format: displayCost=unblended_cost
  // valid values: unblended_cost, true_unblended_cost
  string displayCost = 4;
    
  // Optional. For aws only, filter will be ignored for other vendors.
  // Valid values: default, imported
  string bgType = 5;

  // Optional. Filter by company name.
  string companyName = 6;

  // Optional. Filter by billing group name.
  string billingGroupName = 7;

  // Optional. Filter by billing group id.
  string billingGroupId = 8;

  // Optional. Page size for pagination. Default is 50, maximum is 1000.
  int32 pageSize = 9;

  // Optional. Page token for pagination. Use the next_page_token from the previous response.
  string pageToken = 10;
}

// Response message for the Billing.ListBillingGroups rpc.
message ListBillingGroupsResponse {
  // List of billing groups.
  repeated BillingGroup billingGroups = 1;

  // Total count of billing groups matching the filters.
  int32 totalCount = 2;

  // Current page size.
  int32 pageSize = 3;

  // Links for pagination navigation.
  PaginationLinks links = 4;
}

// Pagination links for navigation.
message PaginationLinks {
  // URL for the next page. Empty if no more pages.
  string next = 1;

  // URL for the previous page. Empty if on the first page.
  string prev = 2;

  // URL for the first page.
  string first = 3;

  // URL for the last page.
  string last = 4;
}